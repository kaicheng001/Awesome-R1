name: 🤖 Auto Update R1 Papers

on:
  schedule:
    - cron: '0 2 * * *'  # Daily at 02:00 UTC (10:00 Beijing Time)
  workflow_dispatch:

jobs:
  update-papers:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: 📥 Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 💡 Set up uv
        uses: astral-sh/setup-uv@v6

      - name: 🐍 Create virtualenv and install dependencies
        run: |
          uv venv .venv
          source .venv/bin/activate
          uv pip install requests python-dateutil beautifulsoup4
        shell: bash

      - name: 🔍 Search and Update Papers
        id: search
        run: |
          source .venv/bin/activate
          python .github/scripts/update_papers.py
          echo "has_changes=$(cat .github/has_changes.txt)" >> $GITHUB_OUTPUT
        shell: bash

      - name: 📅 Get Current Date
        id: date
        run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      - name: ⚖️ Configure Git
        if: steps.search.outputs.has_changes == 'true'
        run: |
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      - name: 📝 Create Commits
        if: steps.search.outputs.has_changes == 'true'
        run: |
          source .venv/bin/activate
          python .github/scripts/commit_papers.py
        shell: bash

      - name: 🔀 Push to New Branch
        if: steps.search.outputs.has_changes == 'true'
        run: |
          BRANCH_NAME="auto-update/r1-papers-${{ steps.date.outputs.date }}"
          git checkout -b "$BRANCH_NAME"
          git push origin "$BRANCH_NAME"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_ENV

      - name: 📜 Create Pull Request
        if: steps.search.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "🤖 [Auto Update] New R1 Papers - ${{ steps.date.outputs.date }}"
          body-path: .github/pr_body.md
          base: main
          branch: ${{ env.branch_name }}
          draft: false

      - name: 📊 Job Summary
        if: always()
        run: |
          if [ "${{ steps.search.outputs.has_changes }}" == "true" ]; then
            echo "## ✅ Update Successful" >> $GITHUB_STEP_SUMMARY
            echo "New papers added! PR created for review." >> $GITHUB_STEP_SUMMARY
          else
            echo "## ℹ️ No Updates Needed" >> $GITHUB_STEP_SUMMARY
            echo "No new R1 papers found today." >> $GITHUB_STEP_SUMMARY
          fi

      - name: 🧹 Cleanup
        if: always()
        run: |
          rm -f .github/has_changes.txt \
                .github/commit_messages.json \
                .github/pr_body.md